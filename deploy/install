#!/bin/bash
export DIRECTORY=gazetteer
export SOLR_VER=6.3.0
export SOLR=solr-$SOLR_VER
export SOLR_ZIP=$SOLR.zip
export SOLR_HOME=$HOME/$SOLR
# cd /home/ec2-user

# Download
cd $HOME

if [ ! -d $SOLR ]; then
   if [ ! -f $SOLR_ZIP ]; then
      /usr/bin/wget http://mirror.intergrid.com.au/apache/lucene/solr/$SOLR_VER/$SOLR.zip
   fi
   usr/bin/unzip $SOLR.zip
fi

# Set up data
if [ ! -d $DIRECTORY ]; then
  git clone https://github.com/Tomella/$DIRECTORY.git
  cd $DIRECTORY
  npm install
else
  cd $DIRECTORY
  git update
  npm update
fi

# Do everything relative to the directory from now on
cp -rf deploy/placenames $SOLR_HOME/server/solr

# Set up service and get it running
sudo cp deploy/solr /etc/init.d
sudo chmod +x /etc/init.d/solr
sudo chkconfig --level 345 solr on
sudo service solr start

# Set up proxying for select
sudo cp $DIRECTORY/deploy/gazetteer.conf /etc/httpd/conf.d
sudo service httpd restart

# Start loading data
cd source
node wfsToSolr

cd $HOME

echo 'Installation complete'